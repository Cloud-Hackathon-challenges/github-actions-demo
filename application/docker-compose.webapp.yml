version: "3.8"

services:
  mongodb:
    # Kolay yol: public'ten çek
    image: mongo:6-jammy
    restart: always
    expose:
      - "27017"
    volumes:
      - ${WEBAPP_STORAGE_HOME}/mongo-data:/data/db

  api:
    image: team1acrmanual9.azurecr.io/api:latest
    environment:
      PORT: "4000"
      MONGO_URI: mongodb://mongodb:27017/dobook
    depends_on:
      - mongodb
    expose:
      - "4000"
    command: ["node","server.js"]

  mongo-seed:
    image: team1acrmanual9.azurecr.io/db-seed:latest
    environment:
      HOST: mongodb
      PORT: "27017"
    depends_on:
      - mongodb
    # mongo hazır olana dek bekle + seed et + grup healthy kalsın
    command: >
      sh -c "
      echo '⏳ waiting mongo';
      for i in $(seq 1 60); do
        mongosh --host mongodb:27017 --quiet --eval 'db.runCommand({ ping: 1 }).ok' && break || sleep 2;
      done &&
      node seed.js &&
      echo '✅ seed done' &&
      tail -f /dev/null
      "

  frontend:
    image: team1acrmanual9.azurecr.io/frontend:latest
    depends_on:
      - api
    expose:
      - "80"
