pleasname: CI/CD - App Service + Terraform + Docker

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20]
        project: [frontend, api]
    defaults:
      run:
        working-directory: application/${{ matrix.project }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: application/${{ matrix.project }}/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test || echo "Tests failed but not blocking"

  terraform:
    name: Provision Azure Infra
    runs-on: ubuntu-latest
    needs: test
    defaults:
      run:
        working-directory: ./terraform
    outputs:
      rg_name:            ${{ steps.tfout.outputs.rg_name }}
      asp_name:           ${{ steps.tfout.outputs.asp_name }}
      app_name:           ${{ steps.tfout.outputs.app_name }}
      acr_name:           ${{ steps.tfout.outputs.acr_name }}
      acr_login_server:   ${{ steps.tfout.outputs.acr_login_server }}
      acr_username:       ${{ steps.tfout.outputs.acr_admin_username }}
      acr_password:       ${{ steps.tfout.outputs.acr_admin_password }}

    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7

      - name: Create dev.tfvars
        run: |
          cat <<EOF > dev.tfvars
          subscription_id = "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          client_id       = "${{ secrets.AZURE_CLIENT_ID }}"
          client_secret   = "${{ secrets.AZURE_CLIENT_SECRET }}"
          tenant_id       = "${{ secrets.AZURE_TENANT_ID }}"
          EOF

      - name: Terraform Init
        run: terraform init -input=false

      - name: Terraform Plan
        run: terraform plan -input=false -var-file="dev.tfvars"

      - name: Terraform Apply
        run: terraform apply -input=false -auto-approve -var-file="dev.tfvars"

      - name: Export Terraform Outputs
        id: tfout
        run: |
          echo "rg_name=$(terraform output -raw rg_name)" >> "$GITHUB_OUTPUT"
          echo "asp_name=$(terraform output -raw asp_name)" >> "$GITHUB_OUTPUT"
          echo "app_name=$(terraform output -raw app_name)" >> "$GITHUB_OUTPUT"
          echo "acr_name=$(terraform output -raw acr_name)" >> "$GITHUB_OUTPUT"
          echo "acr_login_server=$(terraform output -raw acr_login_server)" >> "$GITHUB_OUTPUT"
          echo "acr_admin_username=$(terraform output -raw acr_admin_username)" >> "$GITHUB_OUTPUT"
          echo "acr_admin_password=$(terraform output -raw acr_admin_password)" >> "$GITHUB_OUTPUT"

  docker-build:
    name: Build + Push Docker Images
    runs-on: ubuntu-latest
    needs: terraform
    env:
      ACR_NAME:         ${{ needs.terraform.outputs.acr_name }}
      ACR_LOGIN_SERVER: ${{ needs.terraform.outputs.acr_login_server }}
      ACR_USERNAME:     ${{ needs.terraform.outputs.acr_username }}
      ACR_PASSWORD:     ${{ needs.terraform.outputs.acr_password }}

    steps:
      - uses: actions/checkout@v4

      - name: Login to ACR w/ Admin User
        run: |
          echo "$ACR_PASSWORD" | docker login "$ACR_LOGIN_SERVER" \
          --username "$ACR_USERNAME" --password-stdin

      - name: Build + Push frontend
        run: |
          docker build -t $ACR_LOGIN_SERVER/frontend:latest ./application/frontend
          docker push $ACR_LOGIN_SERVER/frontend:latest

      - name: Build + Push api
        run: |
          docker build -t $ACR_LOGIN_SERVER/api:latest ./application/api
          docker push $ACR_LOGIN_SERVER/api:latest

  app-service-deploy:
    name: Deploy to App Service
    runs-on: ubuntu-latest
    needs: [docker-build, terraform]
    env:
      RG_NAME:          ${{ needs.terraform.outputs.rg_name }}
      ASP_NAME:         ${{ needs.terraform.outputs.asp_name }}
      APP_NAME:         ${{ needs.terraform.outputs.app_name }}
      ACR_LOGIN_SERVER: ${{ needs.terraform.outputs.acr_login_server }}

    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Compose Config
        run: |
          az webapp config container set \
          --name "$APP_NAME" \
          --resource-group "$RG_NAME" \
          --docker-custom-image-name "nginx" \
          --docker-registry-server-url "https://${ACR_LOGIN_SERVER}"

          az webapp config container set \
          --name "$APP_NAME" \
          --resource-group "$RG_NAME" \
          --multicontainer-config-type compose \
          --multicontainer-config-file application/docker-compose.webapp.yml

      - name: Restart Web App
        run: az webapp restart --name "$APP_NAME" --resource-group "$RG_NAME"

  e2e-tests:
    name: Cypress Tests on Live App
    runs-on: ubuntu-latest
    needs: app-service-deploy
    env:
      APP_NAME: ${{ needs.terraform.outputs.app_name }}

    steps:
      - uses: actions/checkout@v4
          
      - uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Cypress deps
        run: npm ci
        working-directory: test

      - name: Run Cypress
        run: npx cypress run
        working-directory: test
        env:
          CYPRESS_BASE_URL: https://${{ env.APP_NAME }}.azurewebsites.net
